<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizza Ticket</title>
    <link rel="stylesheet" href="styles/style.css">
    <style>
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ccc;
        }

        th {
            background-color: #f2f2f2;
        }

        input, select {
            width: 100%;
        }
    </style>
    <h1 id = "hostnameTitle" ></h1>
</head>

<body>
    <label class="theme">
        <div id="themeToggle" class="theme__toggle"></div>
    </label>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        const autorizzato = localStorage.getItem("autorizzato") === "1";
        const hostname = localStorage.getItem("selectedPc");
        const pcType = localStorage.getItem("PcType"); // "portatili" o "fissi"
    
        if (!token) {
            window.location.href = "index.html";
            return;
        }
    
        const toggle = document.getElementById("themeToggle");
        const body = document.body;
        const savedTheme = localStorage.getItem("theme");
    
        if (savedTheme === "dark") {
            body.classList.add("dark-mode");
            toggle.classList.add("checked");
        }
    
        toggle.addEventListener("click", () => {
            body.classList.toggle("dark-mode");
            toggle.classList.toggle("checked");
            localStorage.setItem("theme", body.classList.contains("dark-mode") ? "dark" : "light");
        });
    
        if (hostname) {
            document.getElementById("hostnameTitle").textContent = `Hostname: ${hostname}`;
        } else {
            console.warn("Hostname non trovato nel localStorage");
        }
    
        const ticketBody = document.getElementById("ticketBody");
    
        // Seleziona URL giusto in base a pcType
        let apiUrl = "";
        let hostnameField = "";
    
        if (pcType === "Box") {
            apiUrl = "/ticketf";
            hostnameField = "hostnameF";
        } else if (pcType === "Aule") {
            apiUrl = "/ticketp";
            hostnameField = "hostnameP";
        } else {
            console.error("Valore di pcType non valido");
            console.log(pcType);
            return;
        }
    
        // Effettua richiesta GET
        fetch(apiUrl, {
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Errore nella richiesta API");
            }
            return response.json();
        })
        .then(data => {
            const filteredTickets = data.filter(ticket => ticket[hostnameField] === hostname);
    
            filteredTickets.forEach(ticket => {
                const tr = document.createElement("tr");
    
                tr.innerHTML = `
                    <td>${ticket.id}</td>
                    <td>
                        <input type="text" value="${ticket.descrizione}"
                               onchange="updateTicket(${ticket.id}, 'descrizione', this.value)">
                    </td>
                    <td>${ticket.dataOra}</td>
                    <td>${ticket.creatore}</td>
                    <td>${ticket[hostnameField]}</td>
                    <td>
                        ${autorizzato ? `
                            <input type="text" value="${ticket.tecnico}"
                                   onchange="updateTicket(${ticket.id}, 'tecnico', this.value)">
                        ` : ticket.tecnico}
                    </td>
                    <td>
                        ${autorizzato ? `
                            <select onchange="updateTicket(${ticket.id}, 'stato', this.value)">
                                <option value="Aperto" ${ticket.stato === 'Aperto' ? 'selected' : ''}>Aperto</option>
                                <option value="In lavorazione" ${ticket.stato === 'In lavorazione' ? 'selected' : ''}>In lavorazione</option>
                                <option value="Chiuso" ${ticket.stato === 'Chiuso' ? 'selected' : ''}>Chiuso</option>
                            </select>
                        ` : ticket.stato}
                    </td>
                `;
    
                ticketBody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error("Errore durante il recupero dei ticket:", error);
        });
    
        // Funzione aggiornata per modifiche dinamiche
        window.updateTicket = (idTicket, field, value) => {
            let updateUrl;
            if (field === "descrizione") {
                updateUrl = `${apiUrl}/${idTicket}`;
            } else {
                updateUrl = `${apiUrl}/${idTicket}/${field}`;
            }
    
            fetch(updateUrl, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ [field]: value })
            })
            .then(res => res.json())
            .then(data => console.log("Ticket aggiornato:", data))
            .catch(err => console.error("Errore aggiornamento:", err));
        };
    });
</script>
</body>

</html>