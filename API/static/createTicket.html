<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inserisci Ticket</title>
  <link rel="stylesheet" href="/static/styles/style.css">
  <style>
      body {
          font-family: Arial, sans-serif;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100vh;
          margin: 0;
      }

      form {
          padding: 20px;
          border-radius: 10px;
          display: flex;
          flex-direction: column;
          width: 300px;
      }

     
      #stato {
          margin-bottom: 20px; 
      }


      button {
          margin-top: 10px;
      }
  </style>
</head>
<body>

  <h1>Inserisci Ticket</h1>
  <label class="theme">
    <div id="themeToggle" class="theme__toggle"></div>
  </label>
  <form id="ticketForm">
    <label for="descrizione">Descrizione:</label>
    <textarea id="descrizione" name="descrizione" required></textarea>

    <label id="hostnameLabel" for="hostname">Hostname:</label>
    <input type="text" id="hostname" name="hostname" readonly />

    <label for="stato">Stato:</label>
    <select id="stato" name="stato" required>
      <option value="Aperto">Aperto</option>
      <option value="In lavorazione">In lavorazione</option>
      <option value="Chiuso">Chiuso</option>
    </select>
    
    <button type="submit">Invia Ticket</button>
  </form>

  <script>
    // gestione del tema
    document.addEventListener("DOMContentLoaded", () => {
      const toggle = document.getElementById("themeToggle");
      const body = document.body;
      const savedTheme = localStorage.getItem("theme");

      if (savedTheme === "dark") {
        body.classList.add("dark-mode");
        toggle.classList.add("checked");
      }

      toggle.addEventListener("click", () => {
        body.classList.toggle("dark-mode");
        toggle.classList.toggle("checked");
        localStorage.setItem("theme", body.classList.contains("dark-mode") ? "dark" : "light");
      });
    });

    window.onload = () => {
      const pcType = localStorage.getItem("PcType");
      const hostname = localStorage.getItem("selectedPc");

      const hostnameLabel = document.getElementById("hostnameLabel");
      const hostnameInput = document.getElementById("hostname");

      if (pcType === "Box") {
        hostnameLabel.textContent = "HostnameP:";
        hostnameInput.name = "hostnameP";
      } else {
        hostnameLabel.textContent = "HostnameF:";
        hostnameInput.name = "hostnameF";
      }

      hostnameInput.value = hostname || "";
    };

    document.getElementById("ticketForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const pcType = localStorage.getItem("PcType");
      const selectedPc = localStorage.getItem("selectedPc");
      const UserMail = localStorage.getItem("UserEmail");
      const user = localStorage.getItem("User");

      const form = e.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      data.dataOra = new Date().toISOString(); // Format ISO
      data.creatore = UserMail; // Prelevato da localStorage
      data.tecnico = null; // Tecnico non viene chiesto ora

      if (pcType === "Box") {
        data.hostnameP = selectedPc;
        delete data.hostnameF;
      } else {
        data.hostnameF = selectedPc;
        delete data.hostnameP;
      }

      const endpoint =
        pcType === "Box"
          ? "http://localhost:5000/ticketp"
          : "http://localhost:5000/ticketf";

      try {
        const response = await fetch(endpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data)
        });

        if (response.status === 201) {
          alert("Ticket inserito con successo!");
        } else {
          const error = await response.json();
          alert("Errore: " + (error?.Error || "Errore generico"));
        }
      } catch (err) {
        console.error("Errore nella richiesta:", err);
        alert("Errore di rete durante l'invio.");
      }
    });
  </script>
</body>
</html>
